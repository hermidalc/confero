##############################################################
# CONFERO INSTALLATION
##############################################################
# Requirements:
Perl => 5.12, 5.14, or 5.16
MySQL Server => 5.0, 5.1, or 5.5
Java JRE => 1.6 or 1.7

# Download the Confero project code from SourceForge:

$ git clone https://git.code.sf.net/p/confero/code confero_platform

# Copy and set up your local configuration file: 
# In the folder: confero_platform/lib/perl5/Confero:

$ cp LocalConfig.pm.sample LocalConfig.pm

# Customize LocalConfig.pm for your local installation, typically you would set:

$CTK_BASE_DIR               # Path to confero_platform root directory
$CTK_ADMIN_EMAIL_ADDRESS	# Email address of the administrator
$CTK_DB_HOST                # MySQL server host name
$CTK_DB_NAME                # MySQL database name 
$CTK_DB_USER                # MySQL user name
$CTK_DB_PASS                # MySQL user password
$CTK_WEB_SERVER_HOST		# Apache server hostname
$CTK_WEB_SERVER_PORT		# Apache server port


##############################################################
# Dependencies Installation
##############################################################
# From confero_platform root directory run the dependency installer:

$ ./scripts/cfo_install_deps.sh


##############################################################
# GSEA and MSigDB Installation
##############################################################
# Download the GSEA JAR file from http://www.broadinstitute.org/gsea/downloads.jsp

# Copy the gsea2-x.y.jar into the confero_platform/opt/gsea folder

# Create a symbolic link to gsea2-x.y.jar called gsea.jar:

$ cd opt/gsea
$ ln -s gsea2-x.y.jar gsea.jar

# Download MSigDB datasets from http://www.broadinstitute.org/gsea/downloads.jsp
# into the confero_platform/opt/gsea/data/databases folder.
# All gene sets: "msigdb.vx.y.entrez.gmt", "msigdb.vx.y.symbols.gmt"
# and c1-c6: "c[1-6].*.vx.y.entrez.gmt", "c[1-6].*.vx.y.symbols.gmt"

# You should end up with the following structure
# This is an example with MSigDB v3.1 and gsea2-2.0.12.jar:

opt
└── gsea
    ├── data
    │   ├── databases
    │   │   ├── c1.all.v3.1.entrez.gmt
    │   │   ├── c1.all.v3.1.symbols.gmt
    │   │   ├── c2.all.ar.v3.1.entrez.gmt
    │   │   ├── c2.all.ar.v3.1.symbols.gmt
    │   │   ├── c2.all.v3.1.entrez.gmt
    │   │   ├── c2.all.v3.1.symbols.gmt
    │   │   ├── c2.cgp.ar.v3.1.entrez.gmt
    │   │   ├── c2.cgp.ar.v3.1.symbols.gmt
    │   │   ├── c2.cgp.v3.1.entrez.gmt
    │   │   ├── c2.cgp.v3.1.symbols.gmt
    │   │   ├── c2.cp.biocarta.v3.1.entrez.gmt
    │   │   ├── c2.cp.biocarta.v3.1.symbols.gmt
    │   │   ├── c2.cp.kegg.v3.1.entrez.gmt
    │   │   ├── c2.cp.kegg.v3.1.symbols.gmt
    │   │   ├── c2.cp.reactome.v3.1.entrez.gmt
    │   │   ├── c2.cp.reactome.v3.1.symbols.gmt
    │   │   ├── c2.cp.v3.1.entrez.gmt
    │   │   ├── c2.cp.v3.1.symbols.gmt
    │   │   ├── c3.all.v3.1.entrez.gmt
    │   │   ├── c3.all.v3.1.symbols.gmt
    │   │   ├── c3.mir.v3.1.entrez.gmt
    │   │   ├── c3.mir.v3.1.symbols.gmt
    │   │   ├── c3.tft.v3.1.entrez.gmt
    │   │   ├── c3.tft.v3.1.symbols.gmt
    │   │   ├── c4.all.v3.1.entrez.gmt
    │   │   ├── c4.all.v3.1.symbols.gmt
    │   │   ├── c4.cgn.v3.1.entrez.gmt
    │   │   ├── c4.cgn.v3.1.symbols.gmt
    │   │   ├── c4.cm.v3.1.entrez.gmt
    │   │   ├── c4.cm.v3.1.symbols.gmt
    │   │   ├── c5.all.v3.1.entrez.gmt
    │   │   ├── c5.all.v3.1.symbols.gmt
    │   │   ├── c5.bp.v3.1.entrez.gmt
    │   │   ├── c5.bp.v3.1.symbols.gmt
    │   │   ├── c5.cc.v3.1.entrez.gmt
    │   │   ├── c5.cc.v3.1.symbols.gmt
    │   │   ├── c5.mf.v3.1.entrez.gmt
    │   │   ├── c5.mf.v3.1.symbols.gmt
    │   │   ├── c6.all.v3.1.entrez.gmt
    │   │   ├── c6.all.v3.1.symbols.gmt
    │   │   ├── msigdb.v3.1.entrez.gmt
    │   │   └── msigdb.v3.1.symbols.gmt
    │   └── mappings
    ├── gsea2-2.0.12.jar
    └── gsea.jar -> gsea2-2.0.12.jar


##############################################################
# System Setup
##############################################################

# Run the system setup program and follow the interactive instructions:

$ ./scripts/cfo_setup.pl

# The setup script can take some time to complete due to large amount of public data 
# that is downloaded, parsed, and processed.


##############################################################
# Galaxy Configuration (Optional)
##############################################################
# Make a symbolic link to the confero_platform installation directory in the Galaxy tools directory: 

$ cd /path/to/galaxy-dist/tools
$ ln -s /path/to/confero_platform

# In your Galaxy tool_conf.xml file, add the Confero section and tools:

<section name="Confero Platform" id="confero_platform">
    <label text="Data Import" id="confero_platform_data_import" />
    <tool file="confero_platform/galaxy/upload_rlimmaobject.xml" />
    <tool file="confero_platform/galaxy/generate_idmaps.xml" />
    <tool file="confero_platform/galaxy/submit_contrast_dataset.xml" />
    <tool file="confero_platform/galaxy/submit_gene_set.xml" />
    <label text="Data Management and Export" id="confero_platform_data_mgmt_export" />
    <tool file="confero_platform/galaxy/view_manage_data.xml" />
    <tool file="confero_platform/galaxy/extract_gene_set_matrix.xml" />
    <tool file="confero_platform/galaxy/extract_gene_set_overlap_matrix.xml" />
    <tool file="confero_platform/galaxy/extract_contrast_data_subset.xml" />
    <label text="Functional Enrichment Analysis Module" id="confero_platform_enrich_analysis_module" />
    <tool file="confero_platform/galaxy/create_rnk_deg_lists.xml" />
    <tool file="confero_platform/galaxy/analyze_data.xml" />
    <tool file="confero_platform/galaxy/extract_gsea_leading_edge_matrix.xml" />
    <tool file="confero_platform/galaxy/extract_analysis_results_matrix.xml" />
</section>

# In your Galaxy datatype_conf.xml file, add the Confero data types:

<!-- Confero Platform Datatypes -->
<datatype extension="cforeporthtml" type="galaxy.datatypes.images:Html" subclass="True"/>
<datatype extension="cfocontrastdataset" type="galaxy.datatypes.tabular:Tabular" subclass="True" display_in_upload="true"/>
<datatype extension="cfogeneset" type="galaxy.datatypes.data:Text" subclass="True" display_in_upload="true"/>
<datatype extension="cfornklist" type="galaxy.datatypes.data:Text" subclass="True" display_in_upload="true"/>
<datatype extension="cfodeglist" type="galaxy.datatypes.data:Text" subclass="True" display_in_upload="true"/>
<datatype extension="cfogsearesultshtml" type="galaxy.datatypes.images:Html" subclass="True"/>
<datatype extension="cfohypergresultshtml" type="galaxy.datatypes.images:Html" subclass="True"/>
<datatype extension="cfogsealeadingedgematrix" type="galaxy.datatypes.tabular:Tabular" subclass="True" display_in_upload="true"/>
<datatype extension="cfogsearesultsmatrix" type="galaxy.datatypes.tabular:Tabular" subclass="True" display_in_upload="true"/>
<datatype extension="cfohypergresultsmatrix" type="galaxy.datatypes.tabular:Tabular" subclass="True" display_in_upload="true"/>
<datatype extension="cfogenesetmatrix" type="galaxy.datatypes.tabular:Tabular" subclass="True" display_in_upload="true"/>
<datatype extension="cfogenesetoverlapmatrix" type="galaxy.datatypes.tabular:Tabular" subclass="True" display_in_upload="true"/>
<datatype extension="rlimmaobject" type="galaxy.datatypes.data:Data" subclass="True" mimetype="application/octet-stream" display_in_upload="true"/>
<!-- End Confero Platform Datatypes -->

# Important: make sure the Galaxy system user's environment is using the same Perl used to set up and run Confero

# Restart your Galaxy server instance

